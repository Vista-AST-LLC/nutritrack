<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutrition Tracker</title>
    <meta name="description" content="Track your daily nutrition intake with our comprehensive nutrition tracker">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --success-color: #2ecc71;
            --success-dark: #27ae60;
            --warning-color: #f39c12;
            --warning-dark: #e67e22;
            --danger-color: #e74c3c;
            --danger-dark: #c0392b;
            --text-color: #333;
            --text-light: #7f8c8d;
            --bg-color: #f5f7fa;
            --card-bg: white;
            --border-color: #ecf0f1;
            --shadow: 0 3px 10px rgba(0,0,0,0.08);
            --shadow-hover: 0 5px 15px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 15px;
            color: var(--text-color);
            font-size: 14px;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Focus styles for accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Skip link for keyboard users */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-color);
            color: white;
            padding: 8px;
            text-decoration: none;
            border-radius: 4px;
            z-index: 10000;
        }

        .skip-link:focus {
            top: 6px;
        }

        /* Welcome Screen Styles */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.5s ease;
        }

        .welcome-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .welcome-logo {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .welcome-title {
            font-size: 3rem;
            color: #2c3e50;
            margin-bottom: 10px;
            text-align: center;
        }

        .welcome-subtitle {
            font-size: 1.5rem;
            color: #7f8c8d;
            margin-bottom: 40px;
            text-align: center;
        }

        .welcome-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .welcome-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: var(--shadow-hover);
        }

        .welcome-btn:active {
            transform: translateY(-1px);
        }

        .welcome-screen-2 {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1999;
            transition: opacity 0.5s ease;
        }

        .welcome-screen-2.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .demographics-form {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .demographics-title {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }

        .age-group-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            transition: border-color 0.3s;
        }

        .age-group-select:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .start-btn {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            width: 100%;
        }

        .start-btn:hover {
            background: var(--success-dark);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .start-btn:active {
            transform: translateY(-1px);
        }

        .start-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .back-btn {
            background: transparent;
            color: #7f8c8d;
            border: 1px solid #7f8c8d;
            border-radius: 8px;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .back-btn:hover {
            background: #7f8c8d;
            color: white;
        }

        /* Citations Section */
        .citations-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }

        .citations-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .citations-content {
            font-size: 0.85rem;
            line-height: 1.5;
            color: #555;
        }

        .citation-item {
            margin-bottom: 12px;
            padding-left: 20px;
            text-indent: -20px;
        }

        .citation-number {
            font-weight: bold;
            margin-right: 5px;
        }

        /* Scoring Explanation Section */
        .scoring-explanation {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
        }

        .scoring-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scoring-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .scoring-category {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid;
        }

        .scoring-category h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .scoring-category p {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #555;
            margin-bottom: 8px;
        }

        .scoring-category ul {
            margin-left: 20px;
            font-size: 0.85rem;
            color: #555;
        }

        .scoring-category li {
            margin-bottom: 5px;
        }

        .scoring-optimal { border-left-color: var(--success-color); }
        .scoring-warning { border-left-color: var(--warning-color); }
        .scoring-danger { border-left-color: var(--danger-color); }

        /* Profile Section in Main App */
        .profile-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .profile-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .profile-details h2 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1.3rem;
        }

        .profile-details p {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .change-profile-btn {
            background: var(--warning-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .change-profile-btn:hover {
            background: var(--warning-dark);
            transform: translateY(-2px);
        }

        /* Nutrition Progress Table Styles */
        .nutrition-progress-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .nutrition-progress-table th {
            background: #2c3e50;
            color: white;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
        }

        .nutrition-progress-table td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .nutrition-progress-table tr:last-child td {
            border-bottom: none;
        }

        .nutrition-progress-table tr:hover {
            background-color: #f8f9fa;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .progress-optimal {
            background: var(--success-color);
        }

        .progress-warning {
            background: var(--warning-color);
        }

        .progress-danger {
            background: var(--danger-color);
        }

        .status-optimal {
            color: var(--success-color);
            font-weight: 600;
        }

        .status-warning {
            color: var(--warning-color);
            font-weight: 600;
        }

        .status-danger {
            color: var(--danger-color);
            font-weight: 600;
        }

        /* Age-specific requirements table */
        .requirements-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: var(--shadow);
            font-size: 0.9rem;
        }

        .requirements-table th {
            background: #34495e;
            color: white;
            padding: 10px 12px;
            text-align: center;
            font-weight: 600;
        }

        .requirements-table td {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .requirements-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .user-requirements {
            background: #e8f4fd !important;
            font-weight: 600;
        }

        /* Rest of the CSS remains the same as previous implementation */
        header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            position: relative;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 2rem;
        }

        .subtitle {
            color: #7f8c8d;
            font-size: 1rem;
        }

        .menu-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .instructions-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: white;
            box-shadow: -5px 0 15px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .instructions-panel.active {
            right: 0;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .panel-title {
            font-size: 1.5rem;
            color: #2c3e50;
        }

        .close-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--danger-dark);
            transform: rotate(90deg);
        }

        .instructions-content {
            line-height: 1.6;
        }

        .instructions-content h3 {
            color: #2c3e50;
            margin: 20px 0 10px;
            font-size: 1.2rem;
        }

        .instructions-content p {
            margin-bottom: 15px;
            color: #555;
        }

        .instructions-content ul {
            margin-left: 20px;
            margin-bottom: 20px;
        }

        .instructions-content li {
            margin-bottom: 8px;
            color: #555;
        }

        .instructions-content code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            color: var(--danger-color);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }

        .overlay.active {
            display: block;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 18px;
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.3rem;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .upload-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            left: -9999px;
        }

        .file-label {
            display: block;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .file-label:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .selected-file {
            margin-top: 8px;
            color: #7f8c8d;
            font-style: italic;
            text-align: center;
            font-size: 0.85rem;
        }

        .input-section {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .code-input {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s;
        }

        .code-input:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        .code-input.error {
            border-color: var(--danger-color);
            background-color: #fee;
        }

        .code-input.success {
            border-color: var(--success-color);
            background-color: #efe;
        }

        .add-btn {
            padding: 10px 20px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .add-btn:hover {
            background: var(--success-dark);
            transform: translateY(-2px);
        }

        .add-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .reset-btn {
            padding: 8px 15px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }

        .reset-btn:hover {
            background: var(--danger-dark);
            transform: translateY(-2px);
        }

        .toggle-btn {
            padding: 8px 12px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }

        .toggle-btn:hover {
            background: #8e44ad;
            transform: translateY(-2px);
        }

        .category-section {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        .category-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid;
        }

        .breakfast-box {
            border-left-color: #f39c12;
        }

        .lunch-box {
            border-left-color: var(--primary-color);
        }

        .dinner-box {
            border-left-color: #9b59b6;
        }

        .dessert-box {
            border-left-color: #e84393;
        }

        .category-title {
            font-size: 1.1rem;
            margin-bottom: 12px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .food-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: transform 0.3s;
            font-size: 0.85rem;
        }

        .food-item:hover {
            transform: translateY(-3px);
        }

        .food-name {
            font-weight: 600;
            margin-bottom: 6px;
            color: #2c3e50;
            font-size: 1rem;
        }

        .food-code {
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .food-details {
            font-size: 0.8rem;
            color: #555;
        }

        .nutrition-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
            padding-bottom: 3px;
            border-bottom: 1px dotted var(--border-color);
        }

        .nutrition-label {
            font-weight: 500;
        }

        .nutrition-value {
            font-weight: 600;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-top: 4px solid;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 8px 0;
        }

        .summary-label {
            color: #7f8c8d;
            font-size: 0.8rem;
        }

        .calories-card {
            border-top-color: var(--danger-color);
        }

        .protein-card {
            border-top-color: var(--primary-color);
        }

        .carbs-card {
            border-top-color: var(--success-color);
        }

        .fats-card {
            border-top-color: #f39c12;
        }

        .sodium-card {
            border-top-color: #9b59b6;
        }

        .fiber-card {
            border-top-color: #1abc9c;
        }

        .points-card {
            border-top-color: #8e44ad;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            display: none;
            max-height: 450px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            font-size: 0.8rem;
        }

        th {
            background: #34495e;
            color: white;
            padding: 10px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        tr:nth-child(even) {
            background-color: #fafafa;
        }

        .meal-type {
            padding: 3px 6px;
            border-radius: 3px;
            font-weight: bold;
            font-size: 0.75em;
        }

        .breakfast { background: #ffeaa7; color: #e17055; }
        .lunch { background: #a29bfe; color: white; }
        .dinner { background: #fd79a8; color: white; }
        .dessert { background: #e84393; color: white; }

        .error {
            background: var(--danger-color);
            /*color: white;  // this made the text invisible */
			color: black;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            text-align: center;
            font-size: 0.9rem;
        }

        .success {
            background: var(--success-color);
            /*color: white;  // this made the text invisible */
			color: black;
            padding: 12px;
            border-radius: 6px;
            margin: 12px 0;
            text-align: center;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .remove-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 3px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.75rem;
            margin-top: 8px;
            width: 100%;
            transition: background 0.3s;
        }

        .remove-btn:hover {
            background: var(--danger-dark);
        }

        .points-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 15px;
        }

        .points-circle {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #8e44ad;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 2rem;
            margin-bottom: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }

        .points-label {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .points-description {
            font-size: 0.8rem;
            color: #7f8c8d;
            text-align: center;
            margin-bottom: 15px;
        }

        .points-breakdown {
            width: 100%;
        }

        .points-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .points-nutrient {
            font-weight: 500;
            width: 80px;
            font-size: 0.85rem;
        }

        .points-bar-container {
            flex: 1;
            height: 16px;
            background: var(--border-color);
            border-radius: 8px;
            margin: 0 12px;
            overflow: hidden;
        }

        .points-bar {
            height: 100%;
            border-radius: 8px;
            transition: width 0.5s ease;
        }

        .points-score {
            font-weight: bold;
            width: 35px;
            text-align: right;
            font-size: 0.85rem;
        }

        .positive {
            background: var(--success-color);
        }

        .negative {
            background: var(--danger-color);
        }

        .neutral {
            background: var(--primary-color);
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
                font-size: 13px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .instructions-panel {
                width: 100%;
                right: -100%;
            }
            
            .category-items {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            table {
                font-size: 0.75rem;
            }
            
            th, td {
                padding: 6px 4px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .card-title {
                font-size: 1.2rem;
                margin-bottom: 12px;
            }

            .welcome-title {
                font-size: 2.5rem;
            }
            
            .welcome-subtitle {
                font-size: 1.2rem;
            }
            
            .demographics-form {
                padding: 20px;
            }
            
            .demographics-title {
                font-size: 1.8rem;
            }

            .nutrition-progress-table {
                font-size: 0.75rem;
            }

            .requirements-table {
                font-size: 0.7rem;
            }

            .profile-section {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .profile-info {
                flex-direction: column;
            }

            .scoring-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Skip link for keyboard users -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Welcome Screen 1 -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-logo" aria-hidden="true">üçΩÔ∏è</div>
        <h1 class="welcome-title">Welcome to Culinary Cart</h1>
        <p class="welcome-subtitle">Your personalized nutrition tracking companion</p>
        <button class="welcome-btn" id="welcomeNextBtn">
            Next <span aria-hidden="true">‚Üí</span>
        </button>
    </div>

    <!-- Welcome Screen 2 - Demographics -->
    <div class="welcome-screen-2 hidden" id="demographicsScreen">
        <div class="demographics-form">
            <h2 class="demographics-title">Tell Us About Yourself</h2>
            
            <div class="form-group">
                <label class="form-label" for="ageGroup">Select Your Age Group</label>
                <select id="ageGroup" class="age-group-select" aria-required="true">
                    <option value="">-- Select Age Group --</option>
                    <option value="9-13">9-13 years</option>
                    <option value="14-18">14-18 years</option>
                </select>
            </div>
            
            <button class="start-btn" id="startBtn" disabled>Start Tracking</button>
            <button class="back-btn" id="backBtn"><span aria-hidden="true">‚Üê</span> Back</button>
        </div>
    </div>

    <!-- Main Application (hidden initially) -->
    <div class="container hidden" id="mainApp">
        <!-- Profile Section -->
        <div class="profile-section">
            <div class="profile-info">
                <div class="profile-avatar" id="profileAvatar">U</div>
                <div class="profile-details">
                    <h2 id="profileName">User Profile</h2>
                    <p id="profileDetails">Select your age group to get started</p>
                </div>
            </div>
            <button class="change-profile-btn" id="changeProfileBtn">Change Profile</button>
        </div>

        <header>
            <h1>üçé Nutrition Tracker</h1>
            <div class="subtitle">Track your daily nutrition intake with ease</div>
            <button class="menu-btn" id="menuBtn" aria-expanded="false" aria-controls="instructionsPanel">
                <span aria-hidden="true">‚ò∞</span> Instructions
            </button>
        </header>

        <div class="overlay" id="overlay"></div>

        <div class="instructions-panel" id="instructionsPanel" role="dialog" aria-labelledby="panel-title" aria-modal="true">
            <div class="panel-header">
                <h2 class="panel-title" id="panel-title">Instructions</h2>
                <button class="close-btn" id="closeBtn" aria-label="Close instructions">√ó</button>
            </div>
            <div class="instructions-content">
                <h3>Getting Started</h3>
                <p>Welcome to the Nutrition Tracker! Follow these steps to track your nutrition:</p>
                
                <h3>1. Upload Your Data</h3>
                <p>Start by uploading a CSV file containing your nutrition data:</p>
                <ul>
                    <li>Click the "Choose CSV File" button</li>
                    <li>Select your nutrition data file</li>
                    <li>The file should contain columns for food codes, names, and nutritional values</li>
                </ul>
                
                <h3>2. Add Food Items</h3>
                <p>Once your data is loaded, you can add food items by:</p>
                <ul>
                    <li>Entering the food code in the input field (e.g., <code>B1</code>, <code>L20</code>, <code>D40</code>, <code>F60</code>)</li>
                    <li>Clicking the "Add Food" button or pressing Enter</li>
                    <li>Food items will automatically be categorized by meal type</li>
                    <li>Duplicate items are not allowed - you'll receive a warning</li>
                    <li>Invalid codes will be cleared from the input field</li>
                </ul>
                
                <h3>3. View Your Food Items</h3>
                <p>Your added food items will appear in the appropriate categories:</p>
                <ul>
                    <li><strong>Breakfast</strong> - Morning meals</li>
                    <li><strong>Lunch</strong> - Midday meals</li>
                    <li><strong>Dinner</strong> - Evening meals</li>
                    <li><strong>Dessert</strong> - Sweet treats and desserts</li>
                </ul>
                
                <h3>4. Monitor Nutrition Summary</h3>
                <p>The Nutrition Summary shows your daily totals compared to recommended values:</p>
                <ul>
                    <li>Total calories consumed</li>
                    <li>Macronutrients (protein, carbs, fats)</li>
                    <li>Micronutrients and other components</li>
                </ul>
                
                <h3>5. Check Your Health Score</h3>
                <p>Your Health Score is calculated based on how well your nutrition aligns with daily recommendations:</p>
                <ul>
                    <li>Green score (80-100): Excellent nutrition</li>
                    <li>Orange score (60-79): Good nutrition</li>
                    <li>Red score (0-59): Needs improvement</li>
                </ul>
                
                <h3>Additional Features</h3>
                <ul>
                    <li>Use "Show/Hide Data Table" to view all available food items</li>
                    <li>Remove individual food items with the "Remove" button</li>
                    <li>Reset categories or CSV data using the respective reset buttons</li>
                    <li>Your data is automatically saved between sessions</li>
                </ul>
                
                <h3>Tips for Success</h3>
                <p>For best results:</p>
                <ul>
                    <li>Track all meals and snacks throughout the day</li>
                    <li>Pay attention to portion sizes</li>
                    <li>Aim for a balanced Health Score</li>
                    <li>Use the data to make informed food choices</li>
                </ul>
            </div>
        </div>

		<!-- Two column section begins here -->
        <main id="main-content">
            <div class="main-content">
                <div class="left-column">

                    <div class="card">
                        <h2 class="card-title">Add Food Items</h2>
                        <div class="input-section">
                            <input type="text" id="foodCode" class="code-input" placeholder="Enter food code (e.g., B1, L20, D40, F60)" aria-describedby="codeHelp">
                            <button id="addFoodBtn" class="add-btn">Add Food</button>
                        </div>
                        <div id="codeHelp" class="error-message hidden" aria-live="polite"></div>
                        <button id="toggleTableBtn" class="toggle-btn">üìã Show/Hide Data Table</button>
                        <div id="tableContainer" class="table-container">
                            <div class="virtual-scroll-container">
                                <table id="nutritionTable">
                                    <thead>
                                        <tr>
                                            <th>Code</th>
                                            <th>Item Name</th>
                                            <th>Portion Size</th>
                                            <th>Calories</th>
                                            <th>Protein (g)</th>
                                            <th>Protein (%DV)</th>
                                            <th>Sodium (mg)</th>
                                            <th>Sodium (%DV)</th>
                                            <th>Fats (g)</th>
                                            <th>Fats (%DV)</th>
                                            <th>Carbs (g)</th>
                                            <th>Carbs (%DV)</th>
                                            <th>Fiber (g)</th>
                                            <th>Fiber (%DV)</th>
                                            <th>Cholesterol (mg)</th>
                                            <th>Cholesterol (%DV)</th>
                                            <th>Meal Type</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">üìä Nutrition Summary</h2>
                        
                        <!-- NEW Nutrition Progress Table -->
                        <table class="nutrition-progress-table">
                            <thead>
                                <tr>
                                    <th>Nutrient</th>
                                    <th>Your Intake</th>
                                    <th>Daily Goal</th>
                                    <th>Progress</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Calories</td>
                                    <td id="progressCalories">0 kcal</td>
                                    <td id="goalCalories">-</td>
                                    <td>
                                        <div class="progress-bar">
                                            <div id="caloriesProgress" class="progress-fill" style="width: 0%"></div>
                                        </div>
                                    </td>
                                    <td id="caloriesStatus" class="status-optimal">-</td>
                                </tr>
                                <tr>
                                    <td>Protein</td>
                                    <td id="progressProtein">0g</td>
                                    <td id="goalProtein">-</td>
                                    <td>
                                        <div class="progress-bar">
                                            <div id="proteinProgress" class="progress-fill" style="width: 0%"></div>
                                        </div>
                                    </td>
                                    <td id="proteinStatus" class="status-optimal">-</td>
                                </tr>
                                <tr>
                                    <td>Carbohydrates</td>
                                    <td id="progressCarbs">0g</td>
                                    <td id="goalCarbs">-</td>
                                    <td>
                                        <div class="progress-bar">
                                            <div id="carbsProgress" class="progress-fill" style="width: 0%"></div>
                                        </div>
                                    </td>
                                    <td id="carbsStatus" class="status-optimal">-</td>
                                </tr>
                                <tr>
                                    <td>Fiber</td>
                                    <td id="progressFiber">0g</td>
                                    <td id="goalFiber">-</td>
                                    <td>
                                        <div class="progress-bar">
                                            <div id="fiberProgress" class="progress-fill" style="width: 0%"></div>
                                        </div>
                                    </td>
                                    <td id="fiberStatus" class="status-optimal">-</td>
                                </tr>
                                <tr>
                                    <td>Sodium</td>
                                    <td id="progressSodium">0mg</td>
                                    <td id="goalSodium">-</td>
                                    <td>
                                        <div class="progress-bar">
                                            <div id="sodiumProgress" class="progress-fill" style="width: 0%"></div>
                                        </div>
                                    </td>
                                    <td id="sodiumStatus" class="status-optimal">-</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Age-Specific Requirements Table -->
                        <h3 style="margin: 20px 0 10px;">Age Specific Requirements</h3>
                        <table class="requirements-table">
                            <thead>
                                <tr>
                                    <th>Age Group</th>
                                    <th>Calories (kcal/day)</th>
                                    <th>Sodium (mg/day, max)</th>
                                    <th>Cholesterol (mg/day, max)*</th>
                                    <th>Carbohydrate (g/day)**</th>
                                    <th>Protein (g/day, min)</th>
                                    <th>Fiber (g/day, goal)</th>
                                    <th>Total fat (% of kcal)</th>
                                </tr>
                            </thead>
                            <tbody id="requirementsBody">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                        
                        <div class="summary-grid">
                            <div class="summary-card calories-card">
                                <div class="summary-label">Total Calories</div>
                                <div id="totalCalories" class="summary-value">0</div>
                                <div class="summary-label">kcal</div>
                            </div>
                            <div class="summary-card protein-card">
                                <div class="summary-label">Total Protein</div>
                                <div id="totalProtein" class="summary-value">0</div>
                                <div class="summary-label">grams</div>
                            </div>
                            <div class="summary-card carbs-card">
                                <div class="summary-label">Total Carbs</div>
                                <div id="totalCarbs" class="summary-value">0</div>
                                <div class="summary-label">grams</div>
                            </div>
                            <div class="summary-card fats-card">
                                <div class="summary-label">Total Fats</div>
                                <div id="totalFats" class="summary-value">0</div>
                                <div class="summary-label">grams</div>
                            </div>
                            <div class="summary-card sodium-card">
                                <div class="summary-label">Total Sodium</div>
                                <div id="totalSodium" class="summary-value">0</div>
                                <div class="summary-label">mg</div>
                            </div>
                            <div class="summary-card fiber-card">
                                <div class="summary-label">Total Fiber</div>
                                <div id="totalFiber" class="summary-value">0</div>
                                <div class="summary-label">grams</div>
                            </div>
                        </div>
                    </div>
					
					<!-- Citations Section -->
                    <div class="citations-section">
                        <h3 class="citations-title">üìö Data Sources & Citations</h3>
                        <div class="citations-content">
                            <div class="citation-item">
                                <span class="citation-number">1.</span> Dietary Guidelines for Americans, 2020‚Äì2025. U.S. Department of Agriculture and U.S. Department of Health and Human Services. 9th Edition. December 2020. Available at: https://www.dietaryguidelines.gov
                            </div>
                            <div class="citation-item">
                                <span class="citation-number">2.</span> Appendix E‚Äë3 tables (nutrient goals by age). U.S. Department of Agriculture and U.S. Department of Health and Human Services. 2015‚Äì2020 Dietary Guidelines technical document.
                            </div>
                            <div class="citation-item">
                                <span class="citation-number">3.</span> FDA ‚Äì Daily Values for Nutrition Facts label. U.S. Food and Drug Administration. (Updated 2024.) https://www.fda.gov/food/nutrition-facts-label/daily-value-nutrition-and-supplement-facts-labels
                            </div>
                            <div class="citation-item">
                                <span class="citation-number">4.</span> FDA ‚Äì Key Nutrients and Your Family's Health (kids and teens). U.S. Food and Drug Administration. https://www.fda.gov/media/135619/download
                            </div>
                            <div class="citation-item">
                                <span class="citation-number">5.</span> Dietary Reference Intakes for individuals 4‚Äì18 years. Institute of Medicine (National Academy of Medicine).
                            </div>
                            <div class="citation-item">
                                <span class="citation-number">6.</span> American Heart Association ‚Äì Dietary Recommendations for Healthy Children. (Updated 2024.) https://www.heart.org/en/healthy-living/healthy-eating/eat-smart/nutrition-basics/dietary-recommendations-for-healthy-children
                            </div>
                        </div>
                    </div>
					
					<!-- CSV Upload Section -->
					<div class="card">
                        <h2 class="card-title">
                            Upload Your Data
                            <button id="resetCsvBtn" class="reset-btn">Reset CSV</button>
                        </h2>
                        <div class="upload-section">
                            <div class="file-input-wrapper">
                                <input type="file" id="csvFile" accept=".csv" class="file-input" aria-describedby="fileHelp">
                                <label for="csvFile" class="file-label">üìÅ Choose CSV File</label>
                            </div>
                            <div id="selectedFileName" class="selected-file">No file selected</div>
                            <div id="fileHelp" class="error-message hidden" aria-live="polite"></div>
                        </div>
                    </div>
					
                </div>

                <div class="right-column">
                    <div class="card">
                        <h2 class="card-title">
                            Your Food Items
                            <button id="resetCategoriesBtn" class="reset-btn">Reset Categories</button>
                        </h2>
                        <div class="category-section">
                            <div class="category-box breakfast-box">
                                <div class="category-title">
                                    <span>üç≥ Breakfast</span>
                                    <span id="breakfastCount">0 items</span>
                                </div>
                                <div id="breakfastItems" class="category-items"></div>
                            </div>

                            <div class="category-box lunch-box">
                                <div class="category-title">
                                    <span>ü•™ Lunch</span>
                                    <span id="lunchCount">0 items</span>
                                </div>
                                <div id="lunchItems" class="category-items"></div>
                            </div>

                            <div class="category-box dinner-box">
                                <div class="category-title">
                                    <span>üçΩÔ∏è Dinner</span>
                                    <span id="dinnerCount">0 items</span>
                                </div>
                                <div id="dinnerItems" class="category-items"></div>
                            </div>

                            <div class="category-box dessert-box">
                                <div class="category-title">
                                    <span>üç∞ Dessert</span>
                                    <span id="dessertCount">0 items</span>
                                </div>
                                <div id="dessertItems" class="category-items"></div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2 class="card-title">üèÜ Health Score</h2>
                        <div class="summary-card points-card">
                            <div class="points-display">
                                <div class="points-circle" id="pointsCircle">0</div>
                                <div class="points-label">Health Score</div>
                                <div class="points-description">Based on your age group requirements</div>
                            </div>
                            <div class="points-breakdown">
                                <div class="points-item">
                                    <div class="points-nutrient">Protein</div>
                                    <div class="points-bar-container">
                                        <div id="proteinBar" class="points-bar positive" style="width: 0%"></div>
                                    </div>
                                    <div id="proteinScore" class="points-score">0</div>
                                </div>
                                <div class="points-item">
                                    <div class="points-nutrient">Carbs</div>
                                    <div class="points-bar-container">
                                        <div id="carbsBar" class="points-bar positive" style="width: 0%"></div>
                                    </div>
                                    <div id="carbsScore" class="points-score">0</div>
                                </div>
                                <div class="points-item">
                                    <div class="points-nutrient">Fiber</div>
                                    <div class="points-bar-container">
                                        <div id="fiberBar" class="points-bar positive" style="width: 0%"></div>
                                    </div>
                                    <div id="fiberScore" class="points-score">0</div>
                                </div>
                                <div class="points-item">
                                    <div class="points-nutrient">Sodium</div>
                                    <div class="points-bar-container">
                                        <div id="sodiumBar" class="points-bar negative" style="width: 0%"></div>
                                    </div>
                                    <div id="sodiumScore" class="points-score">0</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scoring Explanation Section -->
                    <div class="scoring-explanation">
                        <h3 class="scoring-title">üìà How Your Health Score is Calculated</h3>
                        <div class="scoring-grid">
                            <div class="scoring-category scoring-optimal">
                                <h4>Scoring System (0-100 points)</h4>
                                <p><strong>80-100 points (Green):</strong> Excellent nutrition! You're meeting or exceeding most recommendations.</p>
                                <p><strong>60-79 points (Orange):</strong> Good nutrition, with some areas for improvement.</p>
                                <p><strong>0-59 points (Red):</strong> Needs improvement in several nutritional areas.</p>
                            </div>
                            <div class="scoring-category scoring-warning">
                                <h4>How to Improve Your Score</h4>
                                <ul>
                                    <li><strong>Increase Protein:</strong> Add lean meats, beans, dairy</li>
                                    <li><strong>Reduce Sodium:</strong> Choose fresh foods over processed</li>
                                    <li><strong>Boost Fiber:</strong> Add fruits, vegetables, whole grains</li>
                                    <li><strong>Balance Carbs:</strong> Choose complex carbs over simple sugars</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div id="loading" class="card loading hidden">
                <span class="loading-spinner" aria-hidden="true"></span> Loading and processing your nutrition data...
            </div>

            <div id="message" class="hidden" role="alert" aria-live="polite"></div>
        </main>
    </div>

    <script>
        // Age Specific Nutrition Requirements from CSV
        const nutritionRequirements = {
            '9-13': {
                calories: { min: 1600, max: 2200 },
                sodium: 1800,
                cholesterol: 300,
                carbs: { min: 180, max: 360 },
                protein: 34,
                fiber: 28.5, // Average of 26-31g
                fat: { min: 25, max: 35 }
            },
            '14-18': {
                calories: { min: 2000, max: 2800 },
                sodium: 2300,
                cholesterol: 300,
                carbs: { min: 225, max: 455 },
                protein: 49, // Average of 46-52g
                fiber: 32, // Average of 26-38g
                fat: { min: 25, max: 35 }
            }
        };

        // Welcome Screen Variables
        const welcomeScreen = document.getElementById('welcomeScreen');
        const demographicsScreen = document.getElementById('demographicsScreen');
        const mainApp = document.getElementById('mainApp');
        const welcomeNextBtn = document.getElementById('welcomeNextBtn');
        const backBtn = document.getElementById('backBtn');
        const startBtn = document.getElementById('startBtn');
        const ageGroupSelect = document.getElementById('ageGroup');
        const changeProfileBtn = document.getElementById('changeProfileBtn');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileDetails = document.getElementById('profileDetails');
        
        // User demographics
        let userAgeGroup = '';
        let userRequirements = null;

        // Welcome Screen Event Listeners
        welcomeNextBtn.addEventListener('click', showDemographicsScreen);
        backBtn.addEventListener('click', showWelcomeScreen);
        startBtn.addEventListener('click', startMainApp);
        changeProfileBtn.addEventListener('click', showDemographicsScreen);
        
        // Age group selection
        ageGroupSelect.addEventListener('change', function() {
            userAgeGroup = this.value;
            checkFormCompletion();
        });

        function showDemographicsScreen() {
            welcomeScreen.classList.add('hidden');
            mainApp.classList.add('hidden');
            demographicsScreen.classList.remove('hidden');
            
            // Reset form
            ageGroupSelect.value = '';
            userAgeGroup = '';
            startBtn.disabled = true;
            
            // Focus on age group select for accessibility
            ageGroupSelect.focus();
        }

        function showWelcomeScreen() {
            demographicsScreen.classList.add('hidden');
            mainApp.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            welcomeNextBtn.focus();
        }

        function checkFormCompletion() {
            if (userAgeGroup) {
                startBtn.disabled = false;
            } else {
                startBtn.disabled = true;
            }
        }

        function startMainApp() {
            // Set user requirements based on age group
            userRequirements = nutritionRequirements[userAgeGroup];
            
            // Update profile display
            updateProfileDisplay();
            
            // Hide welcome screens and show main app
            welcomeScreen.classList.add('hidden');
            demographicsScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            
            // Update requirements table
            updateRequirementsTable();
            
            // Load the main app data
            loadFromLocalStorage();
            
            // Focus on main content for screen readers
            document.getElementById('main-content').focus();
        }

        function updateProfileDisplay() {
            const ageGroupText = userAgeGroup === '9-13' ? '9-13 years' : '14-18 years';
            
            // Update profile avatar with first letter of age group
            profileAvatar.textContent = userAgeGroup.charAt(0);
            
            // Update profile name and details
            profileName.textContent = `${ageGroupText}`;
            profileDetails.textContent = `Personalized nutrition tracking`;
        }

        // ALWAYS show welcome screen when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Always show welcome screen first
            mainApp.classList.add('hidden');
            demographicsScreen.classList.add('hidden');
            welcomeScreen.classList.remove('hidden');
            
            // Still load any existing data for when user completes demographics
            loadFromLocalStorage();
        });

        // Update requirements table with user-specific data
        function updateRequirementsTable() {
            const requirementsBody = document.getElementById('requirementsBody');
            requirementsBody.innerHTML = '';
            
            // Add all age groups to the table
            Object.keys(nutritionRequirements).forEach(key => {
                const req = nutritionRequirements[key];
                const row = document.createElement('tr');
                
                // Highlight the user's row
                if (key === userAgeGroup) {
                    row.classList.add('user-requirements');
                }
                
                const ageGroupText = key === '9-13' ? '9‚Äì13 yrs' : '14‚Äì18 yrs';
                const calorieRange = `${req.calories.min.toLocaleString()}-${req.calories.max.toLocaleString()}`;
                const carbRange = `${req.carbs.min}-${req.carbs.max}`;
                const fiberRange = key === '9-13' ? '26‚Äì31' : '26‚Äì38';
                
                row.innerHTML = `
                    <td>${ageGroupText}</td>
                    <td>~${calorieRange}</td>
                    <td>${req.sodium.toLocaleString()}</td>
                    <td>As low as possible (‚â§${req.cholesterol} as a practical upper limit)</td>
                    <td>‚âà 45‚Äì65% of calories ‚âà ${carbRange} g</td>
                    <td>‚âà ${req.protein} g ${key === '9-13' ? '(RDA for this age)' : '(typical RDA range)'}</td>
                    <td>‚âà ${fiberRange} g ${key === '9-13' ? '(common pediatric targets)' : '(common teen targets)'}</td>
                    <td>${req.fat.min}‚Äì${req.fat.max}% of calories</td>
                `;
                
                requirementsBody.appendChild(row);
            });
        }

        // Global variables
        let nutritionData = [];
        let selectedFoods = [];
        let tableVisible = false;
		
		// Global variables for overall keyboard handling
		let keyLastTime = 0;
		let keyEntry = "";
		
		// Global variable for the specific items that we Added
		let foodEntryCount = 1;

        // DOM elements
        const csvFileInput = document.getElementById('csvFile');
        const selectedFileName = document.getElementById('selectedFileName');
        const foodCodeInput = document.getElementById('foodCode');
        const addFoodBtn = document.getElementById('addFoodBtn');
        const toggleTableBtn = document.getElementById('toggleTableBtn');
        const tableContainer = document.getElementById('tableContainer');
        const tableBody = document.getElementById('tableBody');
        const loadingDiv = document.getElementById('loading');
        const messageDiv = document.getElementById('message');
        const resetCsvBtn = document.getElementById('resetCsvBtn');
        const resetCategoriesBtn = document.getElementById('resetCategoriesBtn');
        const menuBtn = document.getElementById('menuBtn');
        const closeBtn = document.getElementById('closeBtn');
        const instructionsPanel = document.getElementById('instructionsPanel');
        const overlay = document.getElementById('overlay');

        // Category elements
        const breakfastItems = document.getElementById('breakfastItems');
        const lunchItems = document.getElementById('lunchItems');
        const dinnerItems = document.getElementById('dinnerItems');
        const dessertItems = document.getElementById('dessertItems');
        
        // Count elements
        const breakfastCount = document.getElementById('breakfastCount');
        const lunchCount = document.getElementById('lunchCount');
        const dinnerCount = document.getElementById('dinnerCount');
        const dessertCount = document.getElementById('dessertCount');
        
        // Summary elements
        const totalCalories = document.getElementById('totalCalories');
        const totalProtein = document.getElementById('totalProtein');
        const totalCarbs = document.getElementById('totalCarbs');
        const totalFats = document.getElementById('totalFats');
        const totalSodium = document.getElementById('totalSodium');
        const totalFiber = document.getElementById('totalFiber');
        
        // Progress elements
        const progressCalories = document.getElementById('progressCalories');
        const progressProtein = document.getElementById('progressProtein');
        const progressCarbs = document.getElementById('progressCarbs');
        const progressFiber = document.getElementById('progressFiber');
        const progressSodium = document.getElementById('progressSodium');
        
        // Goal elements
        const goalCalories = document.getElementById('goalCalories');
        const goalProtein = document.getElementById('goalProtein');
        const goalCarbs = document.getElementById('goalCarbs');
        const goalFiber = document.getElementById('goalFiber');
        const goalSodium = document.getElementById('goalSodium');
        
        // Progress bars
        const caloriesProgress = document.getElementById('caloriesProgress');
        const proteinProgress = document.getElementById('proteinProgress');
        const carbsProgress = document.getElementById('carbsProgress');
        const fiberProgress = document.getElementById('fiberProgress');
        const sodiumProgress = document.getElementById('sodiumProgress');
        
        // Status elements
        const caloriesStatus = document.getElementById('caloriesStatus');
        const proteinStatus = document.getElementById('proteinStatus');
        const carbsStatus = document.getElementById('carbsStatus');
        const fiberStatus = document.getElementById('fiberStatus');
        const sodiumStatus = document.getElementById('sodiumStatus');
        
        // Points elements
        const pointsCircle = document.getElementById('pointsCircle');
        
        // Points bars
        const proteinBar = document.getElementById('proteinBar');
        const carbsBar = document.getElementById('carbsBar');
        const fiberBar = document.getElementById('fiberBar');
        const sodiumBar = document.getElementById('sodiumBar');
        
        // Points scores
        const proteinScore = document.getElementById('proteinScore');
        const carbsScore = document.getElementById('carbsScore');
        const fiberScore = document.getElementById('fiberScore');
        const sodiumScore = document.getElementById('sodiumScore');

        // Event listeners
        csvFileInput.addEventListener('change', handleFileUpload);
        addFoodBtn.addEventListener('click', addFoodByCode);
        foodCodeInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
				//console.log("Code field entry accepted ", selectedFoods);
			    addFoodByCode();
			}
        });
        toggleTableBtn.addEventListener('click', toggleTable);
        resetCsvBtn.addEventListener('click', resetCsv);
        resetCategoriesBtn.addEventListener('click', resetCategories);
        menuBtn.addEventListener('click', openInstructions);
        closeBtn.addEventListener('click', closeInstructions);
        overlay.addEventListener('click', closeInstructions);

        // Enhanced input validation
        foodCodeInput.addEventListener('input', function() {
            const value = this.value.trim().toUpperCase();
            const codeHelp = document.getElementById('codeHelp');
            
            // Reset visual state
            this.classList.remove('error', 'success');
            codeHelp.classList.add('hidden');
            
            if (value) {
                if (!/^[A-Za-z]\d+$/.test(value)) {
                    this.classList.add('error');
                    codeHelp.textContent = 'Food code should be a letter followed by numbers (e.g., B1, L20)';
                    codeHelp.classList.remove('hidden');
                } else if (nutritionData.length > 0) {
                    // Check if code exists in nutrition data
                    const foodItem = nutritionData.find(item => {
                        const itemCode = String(item.code || '').toUpperCase();
                        return itemCode === value;
                    });
                    
                    if (!foodItem) {
                        this.classList.add('error');
                        codeHelp.textContent = `Food code "${value}" not found in data.`;
                        codeHelp.classList.remove('hidden');
                    /*} else if (selectedFoods.some(item => item.code === foodItem.code)) {  // removing this check so we can add multiple in
                        this.classList.add('error');
                        codeHelp.textContent = `Food with code "${value}" is already added.`;
                        codeHelp.classList.remove('hidden');*/
                    } else {
                        this.classList.add('success');
                    }
                }
            }
        });
		
		// This is handling the overall page entry
		document.addEventListener("keydown", function (e) {
			if (document.activeElement != foodCodeInput) { // ignore all of this if typing in the text field
				if ((Date.now() - keyLastTime) < 60) {  // make sure the scanner is typing and not the person
					keyLastTime = Date.now();
					if ((e.key === 'Enter') || (e.key === 'Tab')) {  // Some scanners send enter, others send tab
						if (keyEntry.length > 0) {
							//console.log("Code accepted");
							foodCodeInput.value = keyEntry; // Makes this compatible with prior programming
							keyEntry = "";
							addFoodByCode();
						}
					} else {
						if (!(e.key === "Shift")) {  // workaround for scanners that send Shift
							//console.log("Add letter " + e.key);
							keyEntry += e.key;
						}
					}
				} else {
					//console.log("Key press " + e.key);
					if (!(e.key === "Shift")) {  // workaround for scanners that send Shift
						keyLastTime = Date.now();  // This needs to be here so that Shift doesn't cause an errant time reset
						keyEntry = e.key;
					}
				}
			}
		});

        function openInstructions() {
            instructionsPanel.classList.add('active');
            overlay.classList.add('active');
            menuBtn.setAttribute('aria-expanded', 'true');
            // Focus on close button for keyboard users
            closeBtn.focus();
        }

        function closeInstructions() {
            instructionsPanel.classList.remove('active');
            overlay.classList.remove('active');
            menuBtn.setAttribute('aria-expanded', 'false');
            // Return focus to menu button
            menuBtn.focus();
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            selectedFileName.textContent = `Selected: ${file.name}`;
            loadingDiv.classList.remove('hidden');
            messageDiv.classList.add('hidden');
            
            // Clear any previous error
            const fileHelp = document.getElementById('fileHelp');
            fileHelp.classList.add('hidden');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                dynamicTyping: true,
                complete: function(results) {
                    loadingDiv.classList.add('hidden');
                    
                    if (results.errors.length > 0) {
                        fileHelp.textContent = 'Error parsing CSV: ' + results.errors[0].message;
                        fileHelp.classList.remove('hidden');
                        showMessage('Error parsing CSV file', 'error');
                        return;
                    }
                    
                    if (results.data.length === 0) {
                        fileHelp.textContent = 'No data found in CSV file.';
                        fileHelp.classList.remove('hidden');
                        showMessage('No data found in CSV file.', 'error');
                        return;
                    }
                    
                    // Validate required columns
                    const requiredColumns = ['code', 'Item Name', 'Calories'];
                    const missingColumns = requiredColumns.filter(col => 
                        !results.meta.fields || !results.meta.fields.includes(col)
                    );
                    
                    if (missingColumns.length > 0) {
                        fileHelp.textContent = `Missing required columns: ${missingColumns.join(', ')}`;
                        fileHelp.classList.remove('hidden');
                        showMessage(`Missing required columns: ${missingColumns.join(', ')}`, 'error');
                        return;
                    }
                    
                    nutritionData = results.data;
                    //console.log('Loaded nutrition data:', nutritionData);
                    updateTable();
                    saveToLocalStorage();
                    showMessage('CSV data loaded successfully! You can now add food items by code.', 'success');
                },
                error: function(error) {
                    loadingDiv.classList.add('hidden');
                    fileHelp.textContent = 'Error reading file: ' + error.message;
                    fileHelp.classList.remove('hidden');
                    showMessage('Error reading file: ' + error.message, 'error');
                }
            });
        }

        function addFoodByCode() {
		
            const code = foodCodeInput.value.trim().toUpperCase();
            const codeHelp = document.getElementById('codeHelp');
            
            // Reset visual state
            foodCodeInput.classList.remove('error', 'success');
            codeHelp.classList.add('hidden');
            
            if (!code) {
                foodCodeInput.classList.add('error');
                codeHelp.textContent = 'Please enter a food code.';
                codeHelp.classList.remove('hidden');
                showMessage('Please enter a food code.', 'error');
                return;
            }
            
            if (nutritionData.length === 0) {
                foodCodeInput.classList.add('error');
                codeHelp.textContent = 'Please upload a CSV file first.';
                codeHelp.classList.remove('hidden');
                showMessage('Please upload a CSV file first.', 'error');
                return;
            }
            
            console.log('Looking for code:', code);
            console.log('Available codes:', nutritionData.map(item => item.code));
            
			// To fix a bug... nutritionData has objects that are passed by reference, not by value
			// This means that all "entities" are just the same entity and changing one changes all
			// There may be a better way to do this though...
			const nutritionDataLocal = structuredClone(nutritionData);

			const foodItem = nutritionDataLocal.find(item => {
                const itemCode = String(item.code || '').toUpperCase();
                return itemCode === code;
            });
            
            if (!foodItem) {
                foodCodeInput.classList.add('error');
                codeHelp.textContent = `Food with code "${code}" not found.`;
                codeHelp.classList.remove('hidden');
                showMessage(`Food with code "${code}" not found.`, 'error');
                // Clear the input field since code is invalid
                foodCodeInput.value = '';
                return;
            }
			
			//console.log("foodItem is now: ", foodItem);
            
            // Check for duplicate // removing this check so we can add multiple in
            /*if (selectedFoods.some(item => item.code === foodItem.code)) {
                foodCodeInput.classList.add('error');
                codeHelp.textContent = `Food with code "${code}" is already added.`;
                codeHelp.classList.remove('hidden');
                showMessage(`Food with code "${code}" is already added.`, 'error');
                // Clear the input field
                foodCodeInput.value = '';
                return;
            }*/
            
            // If all checks pass, add the item
			foodItem.foodEntry = foodEntryCount;
			//foodItem.foodEntry = Date.now();  // was testing
			
			foodEntryCount++;
			
			//console.log('foodItem add:', foodItem.foodEntry);
			
            selectedFoods.push(foodItem);
            updateCategories();
            updateSummary();
            saveToLocalStorage();
			
			//console.log("selected Foods ending: ", selectedFoods);
            
            // Clear the input field after successful addition
            foodCodeInput.value = '';
            foodCodeInput.classList.remove('error', 'success');
            codeHelp.classList.add('hidden');
            
            showMessage(`Added: ${foodItem['Item Name']}`, 'success');
        }

        function removeFood(code) {
			//console.log("Remove food: ", code);
            //selectedFoods = selectedFoods.filter(item => item.code !== code); // Code specific, removed multiple food items
			selectedFoods = selectedFoods.filter(item => item.foodEntry != code);  // https://www.w3schools.com/js/js_comparisons.asp
            updateCategories();
            updateSummary();
            saveToLocalStorage();
            showMessage(`Removed food item.`, 'success');
			//console.log(`Removed food item.`, 'success');
            
            // Clear any validation state on the input field
            foodCodeInput.classList.remove('error', 'success');
            const codeHelp = document.getElementById('codeHelp');
            codeHelp.classList.add('hidden');
        }

        function updateCategories() {
            breakfastItems.innerHTML = '';
            lunchItems.innerHTML = '';
            dinnerItems.innerHTML = '';
            dessertItems.innerHTML = '';
            
            let breakfastCountValue = 0;
            let lunchCountValue = 0;
            let dinnerCountValue = 0;
            let dessertCountValue = 0;
			
			//console.log("Updating categories: ", selectedFoods);
            
            selectedFoods.forEach(item => {
                const mealType = String(item['meal type'] || '').toLowerCase();
                const foodElement = createFoodElement(item);
                
                if (mealType.includes('breakfast')) {
                    breakfastItems.appendChild(foodElement);
                    breakfastCountValue++;
                } else if (mealType.includes('lunch')) {
                    lunchItems.appendChild(foodElement);
                    lunchCountValue++;
                } else if (mealType.includes('dinner')) {
                    dinnerItems.appendChild(foodElement);
                    dinnerCountValue++;
                } else if (mealType.includes('dessert') || mealType.includes('fast')) {
                    dessertItems.appendChild(foodElement);
                    dessertCountValue++;
                }
            });
            
            breakfastCount.textContent = `${breakfastCountValue} item${breakfastCountValue !== 1 ? 's' : ''}`;
            lunchCount.textContent = `${lunchCountValue} item${lunchCountValue !== 1 ? 's' : ''}`;
            dinnerCount.textContent = `${dinnerCountValue} item${dinnerCountValue !== 1 ? 's' : ''}`;
            dessertCount.textContent = `${dessertCountValue} item${dessertCountValue !== 1 ? 's' : ''}`;
			
			//console.log("Updating categories done: ", selectedFoods);
        }

        function createFoodElement(item) {
			//console.log("Food Item create: ", item.foodEntry);
            const foodDiv = document.createElement('div');
            foodDiv.className = 'food-item';
            foodDiv.setAttribute('role', 'listitem');
            
            foodDiv.innerHTML = `
                <div class="food-name">${item['Item Name']}</div>
                <div class="food-code">Code: ${item.code}</div>
                <div class="food-details">
                    <div class="nutrition-row">
                        <span class="nutrition-label">Portion Size:</span>
                        <span class="nutrition-value">${item['Portion Size'] || 'N/A'}</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Calories:</span>
                        <span class="nutrition-value">${item.Calories || 0}</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Protein:</span>
                        <span class="nutrition-value">${item['Protein (g)'] || 0}g (${item['Protein (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Sodium:</span>
                        <span class="nutrition-value">${item['Sodium (mg)'] || 0}mg (${item['Sodium (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Fats:</span>
                        <span class="nutrition-value">${item['Fats (g)'] || 0}g (${item['Fats (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Carbs:</span>
                        <span class="nutrition-value">${item['Carbohydrates (g)'] || 0}g (${item['Carbohydrates (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Fiber:</span>
                        <span class="nutrition-value">${item['Fiber (g)'] || 0}g (${item['Fiber (%DV)'] || 0})</span>
                    </div>
                    <div class="nutrition-row">
                        <span class="nutrition-label">Cholesterol:</span>
                        <span class="nutrition-value">${item['Cholesterol (mg)'] || 0}mg (${item['Cholesterol (%DV)'] || 0})</span>
                    </div>
                </div>
                <button class="remove-btn" onclick="removeFood('${item.foodEntry}')" aria-label="Remove ${item['Item Name']}">Remove</button>
            `;
            
            return foodDiv;  // prior removeFood was item.code, is now foodEntry
        }

        function updateSummary() {
            let calories = 0;
            let protein = 0;
            let carbs = 0;
            let fats = 0;
            let sodium = 0;
            let fiber = 0;
			
			//console.log("Updating summary: ", selectedFoods);
            
            selectedFoods.forEach(item => {
                calories += item.Calories || 0;
                protein += item['Protein (g)'] || 0;
                carbs += item['Carbohydrates (g)'] || 0;
                fats += item['Fats (g)'] || 0;
                sodium += item['Sodium (mg)'] || 0;
                fiber += item['Fiber (g)'] || 0;
            });
            
            // Update summary cards
            totalCalories.textContent = calories;
            totalProtein.textContent = protein.toFixed(1);
            totalCarbs.textContent = carbs.toFixed(1);
            totalFats.textContent = fats.toFixed(1);
            totalSodium.textContent = sodium;
            totalFiber.textContent = fiber.toFixed(1);
            
            // Update progress table
            updateProgressTable(calories, protein, carbs, fiber, sodium);
            
            // Update health score
            updatePointsDisplay(protein, carbs, fiber, sodium);
			
			//console.log("Updating summary done: ", selectedFoods);
        }

        function updateProgressTable(calories, protein, carbs, fiber, sodium) {
            if (!userRequirements) return;
            
            // Update progress values
            progressCalories.textContent = `${calories} kcal`;
            progressProtein.textContent = `${protein.toFixed(1)}g`;
            progressCarbs.textContent = `${carbs.toFixed(1)}g`;
            progressFiber.textContent = `${fiber.toFixed(1)}g`;
            progressSodium.textContent = `${sodium}mg`;
            
            // Update goal values
            goalCalories.textContent = `${userRequirements.calories.min.toLocaleString()}-${userRequirements.calories.max.toLocaleString()} kcal`;
            goalProtein.textContent = `${userRequirements.protein}g`;
            goalCarbs.textContent = `${userRequirements.carbs.min}-${userRequirements.carbs.max}g`;
            goalFiber.textContent = `${userRequirements.fiber}g`;
            goalSodium.textContent = `${userRequirements.sodium.toLocaleString()}mg`;
            
            // Update progress bars and status
            updateProgressBar(caloriesProgress, caloriesStatus, calories, userRequirements.calories.max, 'calories');
            updateProgressBar(proteinProgress, proteinStatus, protein, userRequirements.protein, 'positive');
            updateProgressBar(carbsProgress, carbsStatus, carbs, userRequirements.carbs.max, 'positive');
            updateProgressBar(fiberProgress, fiberStatus, fiber, userRequirements.fiber, 'positive');
            updateProgressBar(sodiumProgress, sodiumStatus, sodium, userRequirements.sodium, 'negative');
        }

        function updateProgressBar(progressElement, statusElement, current, target, type) {
            let percentage;
            let status;
            
            if (type === 'calories') {
                // For calories, we have a range
                const min = userRequirements.calories.min;
                const max = userRequirements.calories.max;
                
                if (current < min) {
                    percentage = (current / min) * 50;
                    status = 'Too Low';
                    progressElement.className = 'progress-fill progress-warning';
                    statusElement.className = 'status-warning';
                } else if (current > max) {
                    percentage = 100;
                    status = 'Too High';
                    progressElement.className = 'progress-fill progress-danger';
                    statusElement.className = 'status-danger';
                } else {
                    // Scale from 50% to 100% within the target range
                    percentage = 50 + ((current - min) / (max - min)) * 50;
                    status = 'Optimal';
                    progressElement.className = 'progress-fill progress-optimal';
                    statusElement.className = 'status-optimal';
                }
            } else if (type === 'positive') {
                // For nutrients where more is better (up to a point)
                percentage = Math.min(100, (current / target) * 100);
                if (percentage >= 80) {
                    status = 'Optimal';
                    progressElement.className = 'progress-fill progress-optimal';
                    statusElement.className = 'status-optimal';
                } else if (percentage >= 50) {
                    status = 'Good';
                    progressElement.className = 'progress-fill progress-warning';
                    statusElement.className = 'status-warning';
                } else {
                    status = 'Low';
                    progressElement.className = 'progress-fill progress-danger';
                    statusElement.className = 'status-danger';
                }
            } else {
                // For nutrients where less is better
                percentage = Math.min(100, (current / target) * 100);
                if (percentage <= 80) {
                    status = 'Optimal';
                    progressElement.className = 'progress-fill progress-optimal';
                    statusElement.className = 'status-optimal';
                } else if (percentage <= 100) {
                    status = 'High';
                    progressElement.className = 'progress-fill progress-warning';
                    statusElement.className = 'status-warning';
                } else {
                    status = 'Too High';
                    progressElement.className = 'progress-fill progress-danger';
                    statusElement.className = 'status-danger';
                }
            }
            
            progressElement.style.width = `${percentage}%`;
            statusElement.textContent = status;
        }

        function updatePointsDisplay(protein, carbs, fiber, sodium) {
            if (!userRequirements) return;
            
            const proteinScoreValue = calculateProteinScore(protein);
            const carbsScoreValue = calculateCarbsScore(carbs);
            const fiberScoreValue = calculateFiberScore(fiber);
            const sodiumScoreValue = calculateSodiumScore(sodium);
            
            const totalScore = Math.max(0, Math.min(100, 
                50 + proteinScoreValue + carbsScoreValue + fiberScoreValue + 
                sodiumScoreValue
            ));
            
            pointsCircle.textContent = Math.round(totalScore);
            pointsCircle.setAttribute('aria-label', `Health Score: ${Math.round(totalScore)} out of 100`);
            
            if (totalScore >= 80) {
                pointsCircle.style.background = '#2ecc71';
            } else if (totalScore >= 60) {
                pointsCircle.style.background = '#f39c12';
            } else {
                pointsCircle.style.background = '#e74c3c';
            }
            
            updateBar(proteinBar, proteinScore, proteinScoreValue, 10);
            updateBar(carbsBar, carbsScore, carbsScoreValue, 10);
            updateBar(fiberBar, fiberScore, fiberScoreValue, 15);
            updateBar(sodiumBar, sodiumScore, sodiumScoreValue, -15);
        }

        function updateBar(barElement, scoreElement, scoreValue, maxScore) {
            const percentage = Math.min(100, Math.abs(scoreValue) / Math.abs(maxScore) * 100);
            barElement.style.width = `${percentage}%`;
            
            scoreElement.textContent = scoreValue > 0 ? `+${scoreValue}` : scoreValue;
            
            if (scoreValue > 0) {
                barElement.className = 'points-bar positive';
            } else if (scoreValue < 0) {
                barElement.className = 'points-bar negative';
            } else {
                barElement.className = 'points-bar neutral';
            }
        }

        function calculateProteinScore(protein) {
            const percent = (protein / userRequirements.protein) * 100;
            if (percent <= 100) {
                return Math.round((percent / 100) * 10);
            } else {
                return 10 - Math.round(((percent - 100) / 100) * 5);
            }
        }

        function calculateCarbsScore(carbs) {
            const percent = (carbs / userRequirements.carbs.max) * 100;
            if (percent <= 100) {
                return Math.round((percent / 100) * 10);
            } else {
                return 10 - Math.round(((percent - 100) / 100) * 15);
            }
        }

        function calculateFiberScore(fiber) {
            const percent = (fiber / userRequirements.fiber) * 100;
            if (percent <= 100) {
                return Math.round((percent / 100) * 10);
            } else {
                return 10 + Math.round(((percent - 100) / 100) * 5);
            }
        }

        function calculateSodiumScore(sodium) {
            const percent = (sodium / userRequirements.sodium) * 100;
            if (percent <= 100) {
                return 0;
            } else {
                return -Math.round(((percent - 100) / 100) * 15);
            }
        }

        function updateTable() {
            tableBody.innerHTML = '';
            
            nutritionData.forEach(item => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${item.code || 'N/A'}</td>
                    <td>${item['Item Name'] || 'N/A'}</td>
                    <td>${item['Portion Size'] || 'N/A'}</td>
                    <td>${item.Calories || 'N/A'}</td>
                    <td>${item['Protein (g)'] || 'N/A'}</td>
                    <td>${item['Protein (%DV)'] || 'N/A'}</td>
                    <td>${item['Sodium (mg)'] || 'N/A'}</td>
                    <td>${item['Sodium (%DV)'] || 'N/A'}</td>
                    <td>${item['Fats (g)'] || 'N/A'}</td>
                    <td>${item['Fats (%DV)'] || 'N/A'}</td>
                    <td>${item['Carbohydrates (g)'] || 'N/A'}</td>
                    <td>${item['Carbohydrates (%DV)'] || 'N/A'}</td>
                    <td>${item['Fiber (g)'] || 'N/A'}</td>
                    <td>${item['Fiber (%DV)'] || 'N/A'}</td>
                    <td>${item['Cholesterol (mg)'] || 'N/A'}</td>
                    <td>${item['Cholesterol (%DV)'] || 'N/A'}</td>
                    <td><span class="meal-type ${getMealTypeClass(item['meal type'])}">${item['meal type'] || 'N/A'}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
        }

        function getMealTypeClass(mealType) {
            if (!mealType) return '';
            const type = String(mealType).toLowerCase();
            if (type.includes('breakfast')) return 'breakfast';
            if (type.includes('lunch')) return 'lunch';
            if (type.includes('dinner')) return 'dinner';
            if (type.includes('dessert') || type.includes('fast')) return 'dessert';
            return '';
        }

        function toggleTable() {
            tableVisible = !tableVisible;
            tableContainer.style.display = tableVisible ? 'block' : 'none';
            toggleTableBtn.textContent = tableVisible ? 'üìã Hide Data Table' : 'üìã Show Data Table';
            toggleTableBtn.setAttribute('aria-expanded', tableVisible);
        }

        function resetCsv() {
            nutritionData = [];
            selectedFoods = [];
			foodEntryCount = 1;
            csvFileInput.value = '';
            selectedFileName.textContent = 'No file selected';
            tableBody.innerHTML = '';
            updateCategories();
            updateSummary();
            saveToLocalStorage();
            showMessage('CSV data has been reset.', 'success');
        }

        function resetCategories() {
            selectedFoods = [];
			foodEntryCount = 1;
            updateCategories();
            updateSummary();
            saveToLocalStorage();
            showMessage('All food items have been removed from categories.', 'success');
        }

        function saveToLocalStorage() {
			//console.log("Saving to local storage");
            localStorage.setItem('nutritionData', JSON.stringify(nutritionData));
            localStorage.setItem('selectedFoods', JSON.stringify(selectedFoods));
            localStorage.setItem('csvFileName', selectedFileName.textContent);
        }

        function loadFromLocalStorage() {
			//console.log("Reading from local storage");
            const savedNutritionData = localStorage.getItem('nutritionData');
            const savedSelectedFoods = localStorage.getItem('selectedFoods');
            const savedCsvFileName = localStorage.getItem('csvFileName');
            
            if (savedNutritionData) {
				//console.log("Restore Nutrition Data");
                nutritionData = JSON.parse(savedNutritionData);
                updateTable();
            }
            
            if (savedSelectedFoods) {
				//console.log("Restore Selected Foods");
                selectedFoods = JSON.parse(savedSelectedFoods);
                updateCategories();
                updateSummary();
				console.log("Selected Foods now: ",selectedFoods);
            }
            
            if (savedCsvFileName && savedCsvFileName !== 'No file selected') {
                //console.log("Restore CSV");
				selectedFileName.textContent = savedCsvFileName;
            }
        }

        function showMessage(message, type) {
            messageDiv.textContent = message;
            messageDiv.className = type;
            messageDiv.classList.remove('hidden');
            
            // Announce to screen readers
            messageDiv.setAttribute('aria-live', 'polite');
            
            setTimeout(() => {
                messageDiv.classList.add('hidden');
            }, 3000);
        }
    </script>
</body>
</html>
